<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product – Catfish Empire™</title>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .nav { background: linear-gradient(45deg, gold, #ffd700); color: #000; padding: 1rem; display:flex; justify-content:space-between; align-items:center; }
    .nav a { color:#000; text-decoration:none; font-weight:bold; margin-left:1rem; }
    .topbar.centered { display:flex; justify-content:center; align-items:center; gap:12px; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; display:grid; grid-template-columns: 1fr 1fr; gap:2rem; }
    .gallery { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem; }
    .main-img { width: 100%; height: 520px; object-fit: contain; background:#111; border-radius:10px; }
    .thumbs { display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap; }
    .thumbs img { width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer; border:2px solid transparent; }
    .thumbs img.active, .thumbs img:hover { border-color: gold; }
    /* Minimal additions for requested hooks */
    .gallery-main img { width:100%; max-width:560px; border-radius:12px; }
    .details { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1.25rem; }
    h1 { color: gold; margin: .25rem 0 1rem; font-size:1.8rem; }
    .desc { color:#ccc; line-height:1.6; margin-bottom:1rem; }
    .row { display:flex; gap:.75rem; margin: .5rem 0; align-items:center; }
    select { background:#111; color:#fff; border:1px solid #444; padding:.6rem .8rem; border-radius:8px; min-width: 160px; }
    .price { font-size:1.6rem; font-weight:bold; margin: 1rem 0; }
    .btn { background: linear-gradient(45deg, #28a745, #34ce57); color:#fff; border:none; padding: .9rem 1.5rem; font-weight:bold; border-radius:10px; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .main-img { height: 380px; } }
  </style>
</head>
<body>
  <div class="nav topbar centered">
    <a href="index.html" class="btn">Home</a>
    <a href="cart.html" class="btn" data-role="cart-badge">Cart (0 – $0.00)</a>
  </div>

  <div class="container">
    <div class="gallery">
      <div class="gallery-main"><img id="g-main" class="main-img" src="TM.png" alt="Product image" /></div>
      <div id="g-thumbs" class="thumbs"></div>
    </div>
    <div class="details">
      <h1 id="p-title">Loading…</h1>
      <div id="p-desc" class="desc"></div>
      <div class="row">
        <label for="sel-color">Primary color</label>
        <select id="sel-color"><option value="">Select color</option></select>
      </div>
      <div class="row">
        <label for="sel-size">Size</label>
        <select id="sel-size"><option value="">Select size</option></select>
      </div>
      <div class="row">
        <label for="sel-qty">Qty</label>
        <input id="sel-qty" type="number" min="1" value="1" />
      </div>
      <div id="p-price" class="price">Select options</div>
      <button id="btn-add" class="btn" disabled>Add to Cart</button>
    </div>
  </div>

  <script type="module" src="/js/header-cart-badge.js"></script>
  <script>
    const BACKEND_URL = window.BACKEND_URL || "https://catfish-stripe-backend.onrender.com";
    const $ = (id) => document.getElementById(id);
    const SIZE_ORDER = ["XS","S","M","L","XL","2XL","3XL","4XL","5XL"];
    const qs = new URLSearchParams(location.search);
    const productId = qs.get("id");

    let productData = null;
    let currentColor = null;
    let currentSize = null;
    let currentVariantId = null;
    let currentPriceCents = null;
    let currentMainImg = null;

    function titleCase(s){ return (s||"").replace(/\b\w/g,c=>c.toUpperCase()); }
    function unique(arr){ const seen=new Set(), out=[]; for (const u of arr){ if(u && !seen.has(u)){ seen.add(u); out.push(u); } } return out; }

    function setMain(src){
      $("g-main").src = src || "";
      currentMainImg = src || "";
      Array.from($("g-thumbs").querySelectorAll("img")).forEach(img=>{
        img.classList.toggle("active", img.dataset.src === src);
      });
    }

    const HIDDEN_URLS = new Set([
      'https://files.cdn.printful.com/files/913/913bbbe9ca436bd693757d21dce528c2_preview.png',
      'https://files.cdn.printful.com/files/b87/b87af5e750905c48adce2f19a3096443_preview.png',
      'https://files.cdn.printful.com/files/f63/f6377c84da44db6dc356547e9066da18_preview.png'
    ]);
    const isDesign = (u='') => {
      const s = String(u).toLowerCase();
      return s.includes('printfile') || s.includes('design');
    };
    function filterImgs(arr){
      return (arr||[]).filter(u => u && !HIDDEN_URLS.has(String(u)) && !isDesign(u));
    }

    function buildGalleryForColor(colorLower){
      const byColor = productData.galleryByColor?.[colorLower];
      const wrap = $("g-thumbs");
      wrap.innerHTML = "";

      // Build ordered list of views first (for consistent UX), then append any remaining images
      const orderedKeys = ['front','left-front','right-front','left','right','back'];
      const fromViews = [];
      if (byColor?.views) {
        for (const k of orderedKeys) {
          const u = byColor.views[k];
          if (u) fromViews.push(u);
        }
      }
      let imgs = filterImgs(unique(fromViews));
      const imagesSet = new Set(imgs);
      const flatImages = filterImgs(byColor?.images?.slice(0) || []);
      for (const u of flatImages) { if (!imagesSet.has(u)) imgs.push(u); }
      if (!imgs.length && Array.isArray(productData.images)) imgs = filterImgs(productData.images.slice(0));

      // Fallback: if this color has too few mockups, borrow ordered views from defaultColor
      if (imgs.length < 2 && productData.defaultColor) {
        const defKey = String(productData.defaultColor||'').toLowerCase();
        if (defKey && defKey !== colorLower) {
          const def = productData.galleryByColor?.[defKey];
          if (def?.views) {
            for (const k of orderedKeys) {
              const u = def.views[k];
              if (u && !imagesSet.has(u)) { imgs.push(u); imagesSet.add(u); }
            }
          }
        }
      }

      imgs.forEach(url=>{
        const t = document.createElement("img");
        t.loading = "lazy"; t.decoding = "async"; t.src = url; t.dataset.src = url; t.onclick = () => setMain(url);
        wrap.appendChild(t);
      });
      const candidate = filterImgs([byColor?.views?.front, imgs[0]]).find(Boolean) || "";
      setMain(candidate);
    }

    function buildColorSelect(){
      const colors = Object.keys(productData.galleryByColor || {}).sort((a,b)=>a.localeCompare(b));
      const def = (productData.defaultColor || "").toLowerCase();
      const sel = $("sel-color"); sel.innerHTML = "";
      colors.forEach(c=>{ const opt=document.createElement("option"); opt.value=c; opt.textContent=titleCase(c); if (c===def) opt.selected=true; sel.appendChild(opt); });
      currentColor = sel.value || def || colors[0] || null;
      sel.onchange = ()=>{ currentColor = sel.value; buildGalleryForColor(currentColor); buildSizeSelect(currentColor); refreshPriceAndVariant(); };
    }

    function buildSizeSelect(colorLower){
      const keys = productData.priceByKey || {}; const sizes = new Set();
      Object.keys(keys).forEach(k=>{ const [c,s]=k.split("|"); if (c===colorLower && s) sizes.add(s); });
      const ordered = Array.from(sizes).sort((a,b)=>{
        const ia = SIZE_ORDER.indexOf(a.toUpperCase()); const ib = SIZE_ORDER.indexOf(b.toUpperCase());
        if (ia===-1 && ib===-1) return a.localeCompare(b); if (ia===-1) return 1; if (ib===-1) return -1; return ia-ib;
      });
      const sel = $("sel-size"); sel.innerHTML = "";
      ordered.forEach(s=>{ const opt=document.createElement("option"); opt.value=s; opt.textContent=s.toUpperCase(); sel.appendChild(opt); });
      currentSize = sel.value || ordered[0] || null;
      sel.onchange = ()=>{ currentSize = sel.value; refreshPriceAndVariant(); };
    }

    function refreshPriceAndVariant(){
      if (!currentColor || !currentSize){ $("p-price").textContent = "$—"; $("btn-add").disabled = true; return; }
      const key = `${currentColor}|${currentSize}`.toLowerCase();
      currentPriceCents = productData.priceByKey?.[key] ?? null;
      currentVariantId   = productData.variantMatrix?.[key] ?? null;
      if (Number.isFinite(currentPriceCents) && currentVariantId){ $("p-price").textContent = `$${(currentPriceCents/100).toFixed(2)}`; $("btn-add").disabled = false; }
      else { $("p-price").textContent = "$—"; $("btn-add").disabled = true; }
    }

    function addToCart(){
      const qty = Math.max(1, parseInt(($("sel-qty").value||"1"),10));
      if (!currentVariantId || !currentPriceCents){ alert("Please choose a color and size."); return; }
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      cart.push({ type:"printful", productId: productData.id, name: productData.name, color: currentColor, size: currentSize, variantId: currentVariantId, priceCents: currentPriceCents, currency:"USD", image: currentMainImg || productData.coverImage || null, qty });
      localStorage.setItem("cart", JSON.stringify(cart));
      try { window.dispatchEvent(new CustomEvent('cart:changed')); } catch(_){}
      if (window.updateCartCount) window.updateCartCount();
      $("btn-add").textContent = "Added!"; setTimeout(()=>($("btn-add").textContent = "Add to Cart"), 900);
    }

    async function boot(){
      if (!productId){ $("p-title").textContent = "Missing product id"; $("btn-add").disabled = true; return; }
      const r = await fetch(`${BACKEND_URL}/api/printful-product/${encodeURIComponent(productId)}?nocache=1`);
      const data = await r.json(); if (!r.ok || data.error){ $("p-title").textContent = "Product not found"; $("btn-add").disabled = true; return; }
      productData = data;
      $("p-title").textContent = productData.name || "Catfish Empire Product";
      $("p-desc").innerHTML = (productData.description || "").replace(/\n/g,"<br>");
      buildColorSelect(); buildGalleryForColor(currentColor); buildSizeSelect(currentColor); refreshPriceAndVariant();
      $("btn-add").onclick = addToCart;
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
