<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catfish Empire™ Etsy Showcase</title>
  <style>
    :root { --gold:#ffd100; }
    * { box-sizing: border-box; }
    body { background:#000; color:#fff; font-family:Arial,Helvetica,sans-serif; margin:0; }
    .toolbar { background:var(--gold); color:#000; font-weight:bold; padding:0.75rem 1rem; display:flex; flex-direction:column; align-items:center; position:sticky; top:0; z-index:1000; }
    .toolbar-title { font-size:1.3rem; font-weight:bold; margin-bottom:0.25rem; }
    .toolbar-links { display:flex; justify-content:space-between; width:100%; max-width:1000px; gap:.5rem; }
    .toolbar-links a { color:var(--gold); background:#000; padding:.35rem .6rem; border-radius:6px; text-decoration:none; font-weight:bold; }
    .toolbar-links a:hover { background:#222; }
    h1 { text-align:center; color:var(--gold); margin:1rem 0 .25rem; }
    .description { text-align:center; max-width:620px; margin:0 auto 1.25rem; color:#ccc; }
    .grid { display:flex; flex-wrap:wrap; justify-content:center; gap:1.25rem; padding:1rem; }
    .card { background:#1f1f1f; border-radius:12px; width:290px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.25); }
    .media { position:relative; background:#111; aspect-ratio:1/1; }
    .media img { width:100%; height:100%; object-fit:cover; display:block; }
    .navBtn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.55); color:var(--gold); border:none; font-size:1.5rem; padding:.25rem .55rem; cursor:pointer; border-radius:8px; opacity:.95; }
    .navPrev { left:6px; } .navNext { right:6px; }
    .navBtn:disabled { opacity:.3; cursor:default; }
    .dots { display:flex; justify-content:center; gap:4px; padding:4px; position:absolute; bottom:6px; left:0; right:0; }
    .dot { width:8px; height:8px; border-radius:50%; background:#666; }
    .dot.active { background:var(--gold); }
    .content { padding:.6rem .75rem .25rem; flex:1; }
    .titleRow { display:flex; justify-content:space-between; align-items:center; gap:.5rem; margin-bottom:.35rem; }
    .title { font-weight:700; font-size:1rem; color:#fff; line-height:1.25; }
    .price { font-weight:700; color:var(--gold); white-space:nowrap; }
    .thumbs { display:flex; gap:5px; overflow-x:auto; padding:.35rem 0 .1rem; scrollbar-width:thin; }
    .thumbs img { width:42px; height:42px; object-fit:cover; border:2px solid transparent; border-radius:7px; cursor:pointer; flex:0 0 auto; }
    .thumbs img.active { border-color:var(--gold); }
    .footer { display:flex; gap:.6rem; padding:.7rem; justify-content:center; }
    .btn { padding:.5rem .75rem; border-radius:7px; text-decoration:none; font-weight:700; text-align:center; flex:1; background:#3f3f3f; color:#fff; }
    .btn:hover { background:#595959; }
    .btn.primary { background:var(--gold); color:#000; }
    .btn.primary:hover { background:#f2c300; }
    .status { text-align:center; padding:1rem; color:#bbb; }
    .placeholder { width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#777; font-size:.9rem; background:linear-gradient(135deg,#0e0e0e,#161616); }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="toolbar-title">CATFISH EMPIRE™ SHOP</div>
    <div class="toolbar-links">
      <a href="index.html">← Back</a>
      <a href="cart.html" class="cart-link">View Cart</a>
    </div>
  </div>

  <h1>Etsy Product Showcase</h1>
  <p class="description">Browse all Catfish Empire™ products currently listed on Etsy.</p>
  <div id="status" class="status">Loading products…</div>
  <div id="grid" class="grid"></div>

<script>
const API = "https://catfish-stripe-backend.onrender.com/etsy/section";

const statusEl = document.getElementById('status');
const grid = document.getElementById('grid');

const PLACEHOLDER_SVG =
  'data:image/svg+xml;utf8,' +
  encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600">
    <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#0e0e0e"/><stop offset="1" stop-color="#161616"/></linearGradient></defs>
    <rect width="600" height="600" fill="url(#g)"/>
    <g fill="#777" font-family="Arial,Helvetica,sans-serif" font-size="22" text-anchor="middle">
      <text x="300" y="300">Preview coming from Etsy…</text>
    </g>
  </svg>`);

function el(tag, cls, txt){
  const e=document.createElement(tag);
  if(cls) e.className=cls;
  if(txt!==undefined) e.textContent=txt;
  return e;
}

function normalizeUrl(u){
  if(!u) return '';
  if(u.startsWith('//')) return 'https:'+u;
  if(u.startsWith('/')) return 'https://www.etsy.com'+u;
  return u.replace(/^http:\/\//i,'https://');
}

function titleFromSlug(url, fallback='Etsy Listing'){
  try{
    const parts = new URL(url).pathname.split('/').filter(Boolean);
    const slug = parts[2] || ''; // /listing/<id>/<slug>
    if(!slug) return fallback;
    return slug.replace(/[-_]+/g,' ')
               .replace(/\s+/g,' ')
               .trim()
               .replace(/\b\w/g, c=>c.toUpperCase());
  }catch{ return fallback; }
}

async function fetchProducts(){
  const r = await fetch(API);
  if(!r.ok) throw new Error('Bad response');
  return await r.json();
}

function render(products){
  statusEl.remove();
  if(!Array.isArray(products) || products.length===0){
    const empty = el('div','status','No Etsy items found right now.');
    grid.after(empty);
    return;
  }

  products.forEach(p=>{
    const imgs = Array.from(new Set((p.images||[])
      .map(normalizeUrl)
      .filter(Boolean)));

    const card = el('article','card');

    // MEDIA
    const media = el('div','media');
    const main = el('img');
    main.alt = (p.title || titleFromSlug(p.url)) + ' mockup';
    main.src = imgs[0] || PLACEHOLDER_SVG;
    media.appendChild(main);

    const prev = el('button','navBtn navPrev'); prev.textContent='⟨';
    const next = el('button','navBtn navNext'); next.textContent='⟩';
    media.appendChild(prev); media.appendChild(next);

    const dots = el('div','dots');
    const dotEls = imgs.map((_,i)=>{ const d=el('div','dot'+(i===0?' active':'')); dots.appendChild(d); return d; });
    media.appendChild(dots);

    // CONTENT
    const content = el('div','content');
    const titleRow = el('div','titleRow');
    const titleEl = el('div','title', p.title || titleFromSlug(p.url));
    const priceEl = el('div','price', p.price || '');
    titleRow.appendChild(titleEl);
    if(p.price) titleRow.appendChild(priceEl);
    const thumbs = el('div','thumbs');
    const thumbEls = imgs.map((src,i)=>{ const t=el('img'); t.src=src; t.alt=(p.title||'Listing')+' thumb '+(i+1); if(i===0) t.classList.add('active'); thumbs.appendChild(t); return t; });

    content.appendChild(titleRow);
    if(thumbEls.length) content.appendChild(thumbs);

    // FOOTER
    const footer = el('div','footer');
    const view = el('a','btn primary','View on Etsy'); view.href = p.url; view.target = '_blank'; view.rel='noopener noreferrer';
    footer.appendChild(view);

    // Assemble
    card.appendChild(media);
    card.appendChild(content);
    card.appendChild(footer);
    grid.appendChild(card);

    // Carousel logic
    let cur=0;
    function show(i){
      if(!imgs.length) return;
      cur=(i+imgs.length)%imgs.length;
      const src = imgs[cur];
      if(main.src !== src) main.src = src;
      dotEls.forEach((d,k)=>d.classList.toggle('active',k===cur));
      thumbEls.forEach((t,k)=>t.classList.toggle('active',k===cur));
      const active = thumbEls[cur];
      if(active?.scrollIntoView) active.scrollIntoView({inline:'center',block:'nearest',behavior:'smooth'});
    }
    if(imgs.length>1){
      prev.addEventListener('click',()=>show(cur-1));
      next.addEventListener('click',()=>show(cur+1));
      thumbEls.forEach((t,i)=>t.addEventListener('click',()=>show(i)));
      media.tabIndex=0;
      media.addEventListener('keydown',e=>{
        if(e.key==='ArrowLeft'){e.preventDefault();show(cur-1);}
        if(e.key==='ArrowRight'){e.preventDefault();show(cur+1);}
      });
      let startX=0,touch=false;
      media.addEventListener('pointerdown',e=>{touch=true;startX=e.clientX;});
      media.addEventListener('pointerup',e=>{
        if(!touch) return; touch=false;
        const dx=e.clientX-startX;
        if(Math.abs(dx)>35) (dx<0?show(cur+1):show(cur-1));
      });
      media.addEventListener('pointercancel',()=>touch=false);
    } else {
      prev.disabled = true; next.disabled = true;
    }
  });
}

fetchProducts()
  .then(p=>Array.isArray(p)?p:[])
  .then(render)
  .catch(err=>{
    statusEl.textContent='Error loading Etsy data.';
    console.error(err);
  });
</script>
</body>
</html>
