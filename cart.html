<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | Catfish Empire</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: black;
      color: white;
      margin: 0;
      padding: 0;
    }
    /* Navigation Toolbar */
    .nav-toolbar {
      background: linear-gradient(45deg, gold, #ffd700);
      color: black;
      font-weight: bold;
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }

    .nav-logo {
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-logo img {
      height: 30px;
      width: auto;
    }

    .nav-links {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .nav-links a {
      color: black;
      text-decoration: none;
      font-weight: bold;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .nav-links a.cart-link {
      background: #333;
      color: gold;
    }

    .nav-links a.cart-link:hover {
      background: #555;
    }
    main {
      max-width: 600px;
      margin: 40px auto;
      background: #111;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid gold;
    }
    h1 {
      color: gold;
      text-align: center;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    button.remove {
      background: crimson;
      color: white;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .summary {
      margin-top: 20px;
      font-size: 1.1rem;
    }
    #checkout {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      font-weight: bold;
      font-size: 1.1rem;
      background: darkgreen;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-toolbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 0.5rem;
      }

      .nav-links {
        justify-content: center;
        gap: 0.5rem;
      }

      .nav-links a {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }

      main {
        margin: 20px auto;
        padding: 0.5rem;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Toolbar -->
  <nav class="nav-toolbar">
    <div class="nav-logo">
      <img src="TM.png" alt="Catfish Empire Logo" onerror="this.style.display='none'" />
      CATFISH EMPIREâ„¢
    </div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="cart.html" class="cart-link">Cart (<span id="cart-count">0</span>)</a>
      <a href="showcase.html">Gallery</a>
      <a href="https://youtube.com/@catfishempire" target="_blank">YouTube</a>
      <a href="https://x.com/CATFISH_EMPIRE" target="_blank">X (Twitter)</a>
      <a href="https://www.facebook.com/share/1B4i7CNrYc/" target="_blank">Facebook</a>
    </div>
  </nav>

  <main>
    <h1>Your Cart</h1>
    <div data-role="cart-root">
      <div data-role="cart-lines"></div>

      <div class="cart-summary">
        <div>Subtotal: <span data-role="subtotal">$0.00</span></div>
        <div id="promo-row" style="margin-top:10px">
          <label for="promoCode">Promo code</label>
          <input id="promoCode" type="text" placeholder="Enter code" style="margin-left:8px;padding:6px 8px;">
          <button id="applyPromoBtn" style="margin-left:8px;padding:6px 10px;">Update promo code</button>
          <small id="promoHint" style="display:block;margin-top:4px;color:#aaa"></small>
        </div>
        <div id="totalsBox" style="margin-top:12px">
          <div>Subtotal: <strong id="subtotalAmount">$0.00</strong></div>
          <div>Discount: <strong id="discountAmount">$0.00</strong></div>
          <div>Shipping: <strong id="shippingAmount">$0.00</strong></div>
          <div>Estimated total (pre-tax): <strong id="estimatedTotalAmount">$0.00</strong></div>
        </div>
        <div class="cart-actions">
          <button class="btn" data-role="update-cart">Update Cart</button>
          <button class="btn btn-primary" data-role="checkout">ðŸ”’ Secure checkout with Stripe</button>
        </div>
      </div>
      <p style="font-size: 0.95rem; color: gray;">Tax and shipping calculated at checkout</p>
    </div>
  </main>

  <script>
    const BACKEND_URL = "https://catfish-stripe-backend.onrender.com";

    // Utilities
    function qSel(s){ return document.querySelector(s); }
    function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
    function dollars(c){ return (n(c)/100).toFixed(2); }
    function normalizeColor(v){ return String(v||'').trim().toLowerCase(); }
    function normalizeSizeLower(v){ return String(v||'').trim().toLowerCase(); }

    // Heal legacy/missing priceCents and variantId using backend product detail
    async function hydratePrintfulItem(item){
      if (Number.isFinite(item.priceCents) && item.variantId) return item;
      try {
        const res = await fetch(`${BACKEND_URL}/api/printful-product/${item.productId}`);
        if (!res.ok) return item;
        const data = await res.json();
        const key = `${normalizeColor(item.color)}|${normalizeSizeLower(item.size)}`;
        const variantId = data.variantMatrix?.[key];
        const priceCents = data.priceByKey?.[key];
        if (variantId) item.variantId = variantId;
        if (Number.isFinite(priceCents)) item.priceCents = Number(priceCents);
      } catch {}
      return item;
    }

    function loadCart(){
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart = cart.map(it => {
        if (it.type === 'printful') {
          if (!Number.isFinite(it.priceCents) && Number.isFinite(it.price)) {
            it.priceCents = Math.round(Number(it.price) * 100);
          }
          if (!Number.isFinite(it.priceCents)) it.priceCents = 0;
        }
        it.qty = Math.max(1, n(it.qty || 1));
        return it;
      });
      return cart;
    }

    function saveCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); }

    function keyFor(it){
      if (it.type === 'printful') return `pf|${it.productId}|${it.variantId||''}|${normalizeColor(it.color)}|${normalizeSizeLower(it.size)}`;
      return `sg|${normalizeColor(it.color)}`;
    }

    function mergeDuplicates(items){
      const map = new Map();
      for (const it of items){
        const k = keyFor(it);
        if (!map.has(k)) map.set(k, { ...it });
        else map.get(k).qty += it.qty;
      }
      return Array.from(map.values());
    }

    function sortByVariant(items){
      return items.slice().sort((a,b)=>{
        if (a.type !== b.type) return a.type.localeCompare(b.type);
        const an = (a.name||'').localeCompare(b.name||''); if (an) return an;
        const ac = normalizeColor(a.color).localeCompare(normalizeColor(b.color)); if (ac) return ac;
        return normalizeSizeLower(a.size).localeCompare(normalizeSizeLower(b.size));
      });
    }

    function subtotalCents(items){
      return items.reduce((sum, it) => sum + ((it.type==='printful'? n(it.priceCents):1499) * (it.qty||1)), 0);
    }

    function renderLines(cart){
      const root = qSel('[data-role="cart-lines"]');
      if (!cart.length){
        root.innerHTML = '<div class="cart-line">Your cart is empty.</div>';
        return;
      }
      root.innerHTML = '';
      cart.forEach((it, idx) => {
        const unit = it.type==='printful' ? n(it.priceCents) : 1499;
        const line = document.createElement('div');
        line.className = 'cart-line';
        line.dataset.index = String(idx);
        const variants = it.type==='printful' ? `Color: ${it.color||'-'} Â· Size: ${(it.size||'').toString().toUpperCase()}` : `${it.color} Sunglasses`;
        line.innerHTML = `
          <div class="line-left">${it.name || 'Catfish Empire Product'}<div style=\"font-size:.9rem;color:#aaa;\">${variants}</div></div>
          <div class="line-mid">
            <div class="qty-control">
              <button type=\"button\" class=\"qty-down\">-</button>
              <input type=\"number\" class=\"qty-input\" min=\"1\" max=\"100\" value=\"${it.qty}\">
              <button type=\"button\" class=\"qty-up\">+</button>
            </div>
          </div>
          <div class="line-right">$${dollars(unit * it.qty)} <button type=\"button\" class=\"remove-line\">Remove</button></div>
        `;
        root.appendChild(line);
      });
    }

    function bindLineEvents(cart){
      const root = qSel('[data-role="cart-lines"]');
      root.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        const row = btn.closest('.cart-line');
        const idx = Number(row.dataset.index);
        if(btn.classList.contains('qty-up')){
          const input = row.querySelector('.qty-input');
          input.value = String(Math.min(100, n(input.value) + 1));
        }
        if(btn.classList.contains('qty-down')){
          const input = row.querySelector('.qty-input');
          input.value = String(Math.max(1, n(input.value) - 1));
        }
        if(btn.classList.contains('remove-line')){
          cart.splice(idx,1);
          saveCart(cart);
          return renderCart();
        }
      });
    }

    function readQuantitiesInto(cart){
      const rows = [...document.querySelectorAll('.cart-line')];
      rows.forEach((row) => {
        const idx = Number(row.dataset.index);
        const input = row.querySelector('.qty-input');
        const qty = Math.max(1, Math.min(100, n(input.value)));
        cart[idx].qty = qty;
      });
    }

    function renderTotals(cart){
      const subtotal = subtotalCents(cart);
      const subEl = qSel('[data-role="subtotal"]');
      if(subEl) subEl.textContent = `$${dollars(subtotal)}`;
      const countEl = document.getElementById('cart-count');
      if (countEl){
        const totalItems = cart.reduce((s,i)=>s+(i.qty||1),0);
        countEl.textContent = totalItems > 0 ? `${totalItems} ($${dollars(subtotal)})` : '0';
      }
    }

    // Promo preview helpers
    const PROMOS = { 'catfish123': { factor: 0.001, label: '99.9% test discount' } };
    const PREVIEW_MIN_CHARGE_CENTS = 50;
    function dollarsLabel(cents){ return `$${(n(cents)/100).toFixed(2)}`; }
    function getActivePromoCode(){ return (localStorage.getItem('cartPromoCode')||'').trim().toLowerCase(); }
    function setActivePromoCode(code){ if(code) localStorage.setItem('cartPromoCode', code.trim().toLowerCase()); else localStorage.removeItem('cartPromoCode'); }
    function computeDiscountedUnitCents(original, promo){ if(!promo) return original; const d = Math.ceil(n(original) * promo.factor); return Math.max(d, PREVIEW_MIN_CHARGE_CENTS); }
    function recalcTotalsPreview(){
      const items = loadCart();
      const code = getActivePromoCode();
      const promo = PROMOS[code] || null;
      let subtotal = 0, discounted = 0;
      for(const it of items){
        const unit = it.type==='printful' ? n(it.priceCents) : 1499;
        const qty = n(it.qty||1);
        subtotal += unit * qty;
        discounted += computeDiscountedUnitCents(unit, promo) * qty;
      }
      const discount = Math.max(0, subtotal - discounted);
      const shipping = (code === 'catfish123') ? 0 : 599;
      return { subtotal, discount, shipping, estimated: discounted + shipping };
    }
    function renderTotalsPreview(){
      const els = {
        sub: document.getElementById('subtotalAmount'),
        disc: document.getElementById('discountAmount'),
        ship: document.getElementById('shippingAmount'),
        tot: document.getElementById('estimatedTotalAmount'),
        hint: document.getElementById('promoHint'),
        input: document.getElementById('promoCode')
      };
      const code = getActivePromoCode();
      const promo = PROMOS[code] || null;
      const t = recalcTotalsPreview();
      if(els.sub) els.sub.textContent = dollarsLabel(t.subtotal);
      if(els.disc) els.disc.textContent = `- ${dollarsLabel(t.discount)}`;
      if(els.ship) els.ship.textContent = dollarsLabel(t.shipping);
      if(els.tot) els.tot.textContent = dollarsLabel(t.estimated);
      if(els.hint){
        if(promo){ els.hint.textContent = `Promo applied: ${promo.label}. One promo per checkout.`; els.hint.style.color = '#2bb24c'; }
        else { els.hint.textContent=''; els.hint.style.color = '#aaa'; }
      }
    }

    async function healCart(cart){
      await Promise.all(cart.map(async (it, idx) => {
        if (it.type === 'printful' && (!Number.isFinite(it.priceCents) || !it.variantId)) {
          cart[idx] = await hydratePrintfulItem({ ...it });
        }
      }));
      return cart;
    }

    async function renderCart(){
      let cart = loadCart();
      cart = await healCart(cart);
      cart = mergeDuplicates(cart);
      cart = sortByVariant(cart);
      saveCart(cart);
      renderLines(cart);
      bindLineEvents(cart);
      renderTotals(cart);
      const updateBtn = qSel('[data-role="update-cart"]');
      if(updateBtn){
        updateBtn.onclick = () => {
          let current = loadCart();
          readQuantitiesInto(current);
          current = mergeDuplicates(current);
          current = sortByVariant(current);
          saveCart(current);
          renderCart();
        };
      }
      const checkoutBtn = qSel('[data-role="checkout"]');
      if (checkoutBtn){
        checkoutBtn.onclick = async () => {
          let current = loadCart();
          readQuantitiesInto(current);
          current = await healCart(current);
          current = mergeDuplicates(current);
          current = sortByVariant(current);
          saveCart(current);
          if (!current.length){ alert('Your cart is empty.'); return; }
          const shippingState = localStorage.getItem('shippingState') || 'Unknown';
          const promoCode = (document.getElementById('promoCode')?.value || '').trim();
          const items = current.map(item => item.type === 'printful' ? ({
            type: 'printful',
            productId: item.productId,
            variantId: item.variantId || item.variant_id,
            name: item.name,
            priceCents: Number(item.priceCents||0),
            currency: item.currency || 'USD',
            image: item.image,
            color: item.color,
            size: item.size,
            qty: item.qty||1
          }) : ({ color: item.color, qty: item.qty||1 }));
          fetch(`${BACKEND_URL}/create-checkout-session`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify({ items, shippingState, promoCode }) })
            .then(r=>r.json()).then(data=>{ if (data.url) window.location = data.url; else alert('Checkout session failed to create.'); })
            .catch(err=>{ console.error('Error:', err); alert('Failed to connect to payment server.'); });
        };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCart();
      const input = document.getElementById('promoCode');
      const btn = document.getElementById('applyPromoBtn');
      if (input) input.value = (localStorage.getItem('cartPromoCode')||'');
      if (btn){
        btn.addEventListener('click', () => {
          const code = (document.getElementById('promoCode')?.value||'').trim().toLowerCase();
          if (code && code !== 'catfish123') localStorage.setItem('cartPromoCode',''); else localStorage.setItem('cartPromoCode', code);
          renderTotalsPreview();
        });
      }
      renderTotalsPreview();
    });
  </script>
  <script type="module" src="/js/header-cart-badge.js"></script>
</body>
</html>
