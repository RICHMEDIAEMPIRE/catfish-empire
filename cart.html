<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | Catfish Empire</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: black;
      color: white;
      margin: 0;
      padding: 0;
    }
    /* Navigation Toolbar */
    .nav-toolbar {
      background: linear-gradient(45deg, gold, #ffd700);
      color: black;
      font-weight: bold;
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }

    .nav-logo {
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-logo img {
      height: 30px;
      width: auto;
    }

    .nav-links {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .nav-links a {
      color: black;
      text-decoration: none;
      font-weight: bold;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .nav-links a.cart-link {
      background: #333;
      color: gold;
    }

    .nav-links a.cart-link:hover {
      background: #555;
    }
    main {
      max-width: 600px;
      margin: 40px auto;
      background: #111;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid gold;
    }
    h1 {
      color: gold;
      text-align: center;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    button.remove {
      background: crimson;
      color: white;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .cart-card { background:#0f1318; border:1px solid #1f2937; border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,.25); padding:24px; }
    .totals-card { background:#0b0f14; border:1px solid #1c2533; border-radius:16px; padding:20px; }
    .btn { display:inline-flex; gap:.5rem; align-items:center; padding:.6rem 1rem; border-radius:12px; border:0; font-weight:700; cursor:pointer; transition:.15s transform ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background:#16a34a; color:#fff; }
    .btn-secondary { background:#334155; color:#e5e7eb; }
    .btn-danger { background:#dc2626; color:#fff; }
    .input { background:#0b0f14; color:#e5e7eb; border:1px solid #293241; border-radius:10px; padding:.55rem .75rem; }
    .qty { display:inline-flex; align-items:center; gap:.5rem; }
    .qty button { width:32px; height:32px; border-radius:8px; }
    .qty-control{ display:flex; align-items:center; gap:.4rem; }
    .qty-control .qty-btn{ width:36px; height:36px; border:0; border-radius:10px; background:linear-gradient(45deg, #facc15, #eab308); color:#111; font-weight:800; cursor:pointer; box-shadow:0 2px 10px rgba(250, 204, 21, 0.25); }
    .qty-control .qty-btn:hover{ filter:brightness(1.05); transform: translateY(-1px); }
    .qty-control .qty-btn:active{ transform: translateY(0); }
    .qty-input{ width:auto; min-width:1.5ch; max-width:4ch; text-align:center; padding:.35rem .25rem; background:#0b0f14; color:#e5e7eb; border:1px solid #293241; border-radius:8px; font-variant-numeric: tabular-nums; }
    /* Remove native number spinners for a cleaner look */
    input.qty-input::-webkit-outer-spin-button,
    input.qty-input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input.qty-input[type=number]{ -moz-appearance:textfield; }
    .line { display:flex; justify-content:space-between; padding:.4rem 0; }
    .line .label { color:#a1a1aa; }
    .line .value { color:#fff; font-weight:600; }
    .text-error{color:#ef4444}
    #checkout {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      font-weight: bold;
      font-size: 1.1rem;
      background: darkgreen;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-toolbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 0.5rem;
      }

      .nav-links {
        justify-content: center;
        gap: 0.5rem;
      }

      .nav-links a {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }

      main {
        margin: 20px auto;
        padding: 0.5rem;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
    /* Promo pill */
    .promo-pill{display:inline-flex;gap:.4rem;align-items:center;padding:.25rem .5rem;border-radius:999px;background:#1f2937;color:#fff;font-size:.875rem}
    .promo-pill button{background:transparent;border:0;color:#fff;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
  <!-- Navigation Toolbar -->
  <nav class="nav-toolbar">
    <div class="nav-logo">
      <img src="TM.png" alt="Catfish Empire Logo" onerror="this.style.display='none'" />
      CATFISH EMPIREâ„¢
    </div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="cart.html" class="cart-link" data-role="cart-badge">Cart (0 â€“ $0.00)</a>
      <a href="showcase.html">Gallery</a>
      <a href="https://youtube.com/@catfishempire" target="_blank">YouTube</a>
      <a href="https://x.com/CATFISH_EMPIRE" target="_blank">X (Twitter)</a>
      <a href="https://www.facebook.com/share/1B4i7CNrYc/" target="_blank">Facebook</a>
    </div>
  </nav>

  <main>
    <h1>Your Cart</h1>
    <div id="cart-root" data-role="cart-root" class="cart-card">
      <div data-role="cart-lines"></div>

      <div id="cart-totals" class="totals-card" style="margin-top:16px">
        <div class="promo-row" style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:.5rem">
          <input id="promoCode" class="input" type="text" placeholder="Promo code" />
          <button id="applyPromoBtn" class="btn btn-primary">Apply / Update</button>
          <small id="promoHint" class="text-error" style="display:none"></small>
          <span id="applied-promo" class="promo-pill" style="display:none"></span>
        </div>
        <div class="line"><span class="label">Subtotal</span> <span class="value" id="subtotalAmount">$0.00</span></div>
        <div class="line"><span class="label">Discount</span> <span class="value" id="discountAmount">â€”</span></div>
        <div class="line"><span class="label">Shipping</span> <span class="value" id="shippingAmount">$0.00</span></div>
        <div class="line"><span class="label">Total</span> <span class="value" id="estimatedTotalAmount">$0.00</span></div>
        <div class="cart-actions" style="margin-top:12px;display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-secondary" data-role="update-cart">Update Cart</button>
          <button class="btn btn-primary" data-role="checkout">ðŸ”’ Secure checkout with Stripe</button>
        </div>
      </div>
      <p style="font-size: 0.95rem; color: gray;">Shipping calculated at checkout</p>
    </div>
  </main>

  <script type="module">
    import { getCart, setCart, getPromo, setPromo, getTotals, formatMoney } from '/js/cart-state.js';
    import { renderToolbarTotals } from '/js/toolbar.js';

    const BACKEND_URL = "https://catfish-stripe-backend.onrender.com";

    // Utilities
    function qSel(s){ return document.querySelector(s); }
    function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
    function dollars(c){ return (n(c)/100).toFixed(2); }
    function normalizeColor(v){ return String(v||'').trim().toLowerCase(); }
    function normalizeSizeLower(v){ return String(v||'').trim().toLowerCase(); }

    // Heal legacy/missing priceCents and variantId using backend product detail
    async function hydratePrintfulItem(item){
      if (Number.isFinite(item.priceCents) && item.variantId) return item;
      try {
        const res = await fetch(`${BACKEND_URL}/api/printful-product/${item.productId}`);
        if (!res.ok) return item;
        const data = await res.json();
        const key = `${normalizeColor(item.color)}|${normalizeSizeLower(item.size)}`;
        const variantId = data.variantMatrix?.[key];
        const priceCents = data.priceByKey?.[key];
        if (variantId) item.variantId = variantId;
        if (Number.isFinite(priceCents)) item.priceCents = Number(priceCents);
      } catch {}
      return item;
    }

    function loadCart(){
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart = cart.map(it => {
        if (it.type === 'printful') {
          if (!Number.isFinite(it.priceCents) && Number.isFinite(it.price)) {
            it.priceCents = Math.round(Number(it.price) * 100);
          }
          if (!Number.isFinite(it.priceCents)) it.priceCents = 0;
        }
        it.qty = Math.max(1, n(it.qty || 1));
        return it;
      });
      return cart;
    }

    function saveCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); }

    function keyFor(it){
      if (it.type === 'printful') return `pf|${it.productId}|${it.variantId||''}|${normalizeColor(it.color)}|${normalizeSizeLower(it.size)}`;
      return `sg|${normalizeColor(it.color)}`;
    }

    function mergeDuplicates(items){
      const map = new Map();
      for (const it of items){
        const k = keyFor(it);
        if (!map.has(k)) map.set(k, { ...it });
        else map.get(k).qty += it.qty;
      }
      return Array.from(map.values());
    }

    function sortByVariant(items){
      return items.slice().sort((a,b)=>{
        if (a.type !== b.type) return a.type.localeCompare(b.type);
        const an = (a.name||'').localeCompare(b.name||''); if (an) return an;
        const ac = normalizeColor(a.color).localeCompare(normalizeColor(b.color)); if (ac) return ac;
        return normalizeSizeLower(a.size).localeCompare(normalizeSizeLower(b.size));
      });
    }

    function subtotalCents(items){
      return items.reduce((sum, it) => sum + ((it.type==='printful'? n(it.priceCents):1499) * (it.qty||1)), 0);
    }

    function renderLines(cart){
      const root = qSel('[data-role="cart-lines"]');
      if (!cart.length){
        root.innerHTML = '<div class="cart-line">Your cart is empty.</div>';
        return;
      }
      root.innerHTML = '';
      cart.forEach((it, idx) => {
        const unit = it.type==='printful' ? n(it.priceCents) : 1499;
        const line = document.createElement('div');
        line.className = 'cart-line';
        line.dataset.index = String(idx);
        const variants = it.type==='printful' ? `Color: ${it.color||'-'} Â· Size: ${(it.size||'').toString().toUpperCase()}` : `${it.color} Sunglasses`;
        line.innerHTML = `
          <div class="line-left">${it.name || 'Catfish Empire Product'}<div style=\"font-size:.9rem;color:#aaa;\">${variants}</div></div>
          <div class="line-mid">
            <div class="qty-control">
              <button type=\"button\" class=\"qty-btn qty-down\">-</button>
              <input type=\"number\" class=\"qty-input\" min=\"1\" max=\"100\" value=\"${it.qty}\">
              <button type=\"button\" class=\"qty-btn qty-up\">+</button>
            </div>
          </div>
          <div class=\"line-right\">$${dollars(unit * it.qty)} <button type=\"button\" class=\"btn btn-secondary remove-line\">Remove</button></div>
        `;
        root.appendChild(line);
      });
    }

    let delegated = false;
    function bindLineEvents(){
      if (delegated) return; delegated = true;
      document.addEventListener('click', (e) => {
        const row = e.target.closest('.cart-line');
        if (!row) return;
        const idx = Number(row.dataset.index);
        const btn = e.target.closest('button');
        if (!btn) return;
        const input = row.querySelector('.qty-input');
        if (btn.classList.contains('qty-up') || btn.matches('.qty-btn.qty-up')){
          input.value = String(Math.min(100, n(input.value) + 1));
          const current = getCart(); current[idx].qty = Math.min(100, n(input.value)); setCart(current); renderCart();
        } else if (btn.classList.contains('qty-down') || btn.matches('.qty-btn.qty-down')){
          input.value = String(Math.max(1, n(input.value) - 1));
          const current = getCart(); current[idx].qty = Math.max(1, n(input.value)); setCart(current); renderCart();
        } else if (btn.classList.contains('remove-line')){
          const current = getCart(); current.splice(idx,1); setCart(current); renderCart();
        }
      });
      document.addEventListener('change', (e) => {
        if (!e.target.classList.contains('qty-input')) return;
        const row = e.target.closest('.cart-line'); if (!row) return;
        const idx = Number(row.dataset.index);
        const current = getCart(); current[idx].qty = Math.max(1, Math.min(100, n(e.target.value))); setCart(current); renderCart();
      });
    }

    function readQuantitiesInto(cart){
      const rows = [...document.querySelectorAll('.cart-line')];
      rows.forEach((row) => {
        const idx = Number(row.dataset.index);
        const input = row.querySelector('.qty-input');
        const qty = Math.max(1, Math.min(100, n(input.value)));
        cart[idx].qty = qty;
      });
    }

    function renderSummary(){
      const cart = getCart();
      const promo = getPromo();
      const { subtotalCents, discountCents, shippingCents, totalCents } = computeTotals(cart, promo);
      const els = {
        sub: document.getElementById('subtotalAmount'),
        disc: document.getElementById('discountAmount'),
        ship: document.getElementById('shippingAmount'),
        tot: document.getElementById('estimatedTotalAmount'),
        pill: document.getElementById('applied-promo')
      };
      if (els.sub) els.sub.textContent = formatMoney(subtotalCents);
      if (els.disc) els.disc.textContent = discountCents ? `- ${formatMoney(discountCents)}` : 'â€”';
      if (els.ship) els.ship.textContent = formatMoney(shippingCents);
      if (els.tot) els.tot.textContent = formatMoney(totalCents);
      const pillWrap = document.getElementById('applied-promo');
      if (pillWrap){
        if (promo && promo.code){
          pillWrap.style.display = 'inline-flex';
          let pillText = `${promo.code.toUpperCase()}`;
          if (promo.mode === 'oneDollar') pillText += ' â€“ $1 test';
          else if (promo.mode === 'flat50') pillText += ' â€“ $0.50/item';
          else pillText += ` â€“ ${promo.percent}%`;
          pillWrap.innerHTML = `${pillText} <button aria-label="Remove" id="remove-promo">Ã—</button>`;
          const btn = pillWrap.querySelector('#remove-promo');
          btn.addEventListener('click', () => { setPromo(null); renderSummary(); renderToolbarTotals(); });
        } else {
          pillWrap.style.display = 'none';
          pillWrap.innerHTML = '';
        }
      }
    }

    // Promo helpers via backend
    function dollarsLabel(cents){ return `$${(n(cents)/100).toFixed(2)}`; }
    async function recalcTotalsPreview(override){
      const items = loadCart();
      let subtotal = 0;
      for(const it of items){
        const unit = it.type==='printful' ? n(it.priceCents) : 1499;
        const qty = n(it.qty||1);
        subtotal += unit * qty;
      }
      let pct = 0, promoObj = null;
      if (override && typeof override.percent === 'number') {
        pct = override.percent; promoObj = { code: override.code||'', percent: pct };
      } else {
        try {
          const r = await fetch(`${BACKEND_URL}/api/promo/active`, { credentials:'include' });
          const pj = await r.json();
          pct = pj?.promo?.percent || 0;
          promoObj = pj?.promo || null;
        } catch (_) { pct = 0; }
      }
      const discounted = Math.max(0, Math.round(subtotal * (100 - pct) / 100));
      const discount = Math.max(0, subtotal - discounted);
      const shipping = 599;
      return { subtotal, discount, shipping, estimated: discounted + shipping, promo: promoObj };
    }
    async function renderTotalsPreview(override){
      const els = {
        sub: document.getElementById('subtotalAmount'),
        disc: document.getElementById('discountAmount'),
        ship: document.getElementById('shippingAmount'),
        tot: document.getElementById('estimatedTotalAmount'),
        hint: document.getElementById('promoHint'),
        input: document.getElementById('promoCode')
      };
      const t = await recalcTotalsPreview(override);
      if(els.sub) els.sub.textContent = dollarsLabel(t.subtotal);
      if(els.disc) els.disc.textContent = `- ${dollarsLabel(t.discount)}`;
      if(els.ship) els.ship.textContent = dollarsLabel(t.shipping);
      if(els.tot) els.tot.textContent = dollarsLabel(t.estimated);
      if(els.hint){
        if(t.promo){ els.hint.textContent = `Promo applied: ${t.promo.code.toUpperCase()} (${t.promo.percent}%). One promo per checkout.`; els.hint.style.color = '#2bb24c'; }
        else { els.hint.textContent=''; els.hint.style.color = '#aaa'; }
      }
    }

    async function healCart(cart){
      await Promise.all(cart.map(async (it, idx) => {
        if (it.type === 'printful' && (!Number.isFinite(it.priceCents) || !it.variantId)) {
          cart[idx] = await hydratePrintfulItem({ ...it });
        }
      }));
      return cart;
    }

    async function renderCart(){
      let cart = getCart();
      cart = await healCart(cart);
      cart = mergeDuplicates(cart);
      cart = sortByVariant(cart);
      setCart(cart);
      renderLines(cart);
      bindLineEvents(cart);
      renderSummary();
      renderToolbarTotals();
      const updateBtn = qSel('[data-role="update-cart"]');
      if(updateBtn){
        updateBtn.onclick = () => {
          let current = getCart();
          readQuantitiesInto(current);
          current = mergeDuplicates(current);
          current = sortByVariant(current);
          setCart(current);
          renderCart();
          renderToolbarTotals();
        };
      }
      const checkoutBtn = qSel('[data-role="checkout"]');
      if (checkoutBtn){
        checkoutBtn.onclick = async () => {
          let current = getCart();
          readQuantitiesInto(current);
          current = await healCart(current);
          current = mergeDuplicates(current);
          current = sortByVariant(current);
          setCart(current);
          if (!current.length){ alert('Your cart is empty.'); return; }
          const shippingState = localStorage.getItem('shippingState') || 'Unknown';
          const curPromo = getPromo();
          const promoCode = curPromo?.code || (document.getElementById('promoCode')?.value || '').trim();
          const items = current.map(item => item.type === 'printful' ? ({
            type: 'printful',
            productId: item.productId,
            variantId: item.variantId || item.variant_id,
            name: item.name,
            priceCents: Number(item.priceCents||0),
            currency: item.currency || 'USD',
            image: item.image,
            color: item.color,
            size: item.size,
            qty: item.qty||1
          }) : ({ color: item.color, qty: item.qty||1 }));
          fetch(`${BACKEND_URL}/create-checkout-session`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify({ items, shippingState, promoCode }) })
            .then(async r => {
              const text = await r.text();
              let data; try { data = JSON.parse(text); } catch { data = { raw: text }; }
              if (!r.ok) throw new Error(data?.error || 'Checkout failed');
              if (data.url) window.location = data.url; else alert('Checkout session failed to create.');
            })
            .catch(err=>{ console.error('Error:', err); alert(err.message || 'Failed to connect to payment server.'); });
        };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCart();
      const input = document.getElementById('promoCode');
      const applyBtn = document.getElementById('applyPromoBtn');
      const clearBtn = document.getElementById('clearPromoBtn');
      if (applyBtn){
        applyBtn.addEventListener('click', async () => {
          const codeInput = (input?.value||'').trim().toLowerCase().replace(/\s+/g,'');
          const hint = document.getElementById('promoHint');
          if (!codeInput) {
            setPromo(null);
            if (hint) { hint.textContent=''; hint.style.color='#aaa'; hint.style.display='none'; }
            renderSummary();
            renderToolbarTotals();
            return;
          }
          // Validate server-side (supports code1..code5)
          let resp = await fetch(`${BACKEND_URL}/api/promo/validate`, {
            method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify({ code: codeInput })
          }).catch(()=>null);
          if (!resp || !resp.ok) {
            if (hint) { hint.textContent = 'Invalid code'; hint.style.color = '#ff6b6b'; hint.style.display='block'; }
            setPromo(null);
            renderSummary();
            renderToolbarTotals();
            return;
          }
          const data = await resp.json().catch(()=>({}));
          const isOneDollar = data?.mode === 'oneDollar';
          const isFlat = data?.mode === 'flat50';
          const percent = (isOneDollar || isFlat) ? 0 : Number(data?.percent || data?.promo?.percent || 0);
          const code = String(data?.code || data?.promo?.code || codeInput).toLowerCase();
          if (!(percent > 0)) {
            if (!isOneDollar && !isFlat){
              if (hint) { hint.textContent = 'Invalid or inactive code'; hint.style.color = '#ff6b6b'; hint.style.display='block'; }
              setPromo(null);
              renderSummary();
              renderToolbarTotals();
              return;
            }
          }
          // Persist promo locally and in session for checkout
          if (isOneDollar) {
            setPromo({ code, percent: 0, mode: 'oneDollar' });
          } else if (isFlat) {
            setPromo({ code, percent: 0, mode: 'flat50' });
        } else {
            setPromo({ code, percent });
          }
          try { await fetch(`${BACKEND_URL}/api/promo/apply`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify({ code }) }); } catch {}
          // Force recompute/paint immediately for cart + toolbar
          try { window.dispatchEvent(new CustomEvent('cart:changed')); } catch {}
          renderSummary();
          renderToolbarTotals();
          if (hint) { 
            let msg = `Promo applied: ${code.toUpperCase()}`;
            if (isOneDollar) msg += ' ($1 test mode)';
            else if (isFlat) msg += ' ($0.50 per item)';
            else msg += ` (${percent}%)`;
            hint.textContent = msg; 
            hint.style.color = '#2bb24c'; 
            hint.style.display='block'; 
          }
        });
      }
      if (clearBtn){
        clearBtn.addEventListener('click', async () => {
          setPromo(null);
          renderSummary();
          renderToolbarTotals();
        });
      }
      renderSummary();
    });
  </script>
  <script type="module" src="/js/cart-state.js"></script>
  <script type="module" src="/js/toolbar.js"></script>
  <script src="/js/donate.js" defer></script>
</body>
</html>
