<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart | Catfish Empire</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: black;
      color: white;
      margin: 0;
      padding: 0;
    }
    /* Navigation Toolbar */
    .nav-toolbar {
      background: linear-gradient(45deg, gold, #ffd700);
      color: black;
      font-weight: bold;
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }

    .nav-logo {
      font-size: 1.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-logo img {
      height: 30px;
      width: auto;
    }

    .nav-links {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .nav-links a {
      color: black;
      text-decoration: none;
      font-weight: bold;
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .nav-links a:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .nav-links a.cart-link {
      background: #333;
      color: gold;
    }

    .nav-links a.cart-link:hover {
      background: #555;
    }
    main {
      max-width: 600px;
      margin: 40px auto;
      background: #111;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid gold;
    }
    h1 {
      color: gold;
      text-align: center;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    button.remove {
      background: crimson;
      color: white;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .summary {
      margin-top: 20px;
      font-size: 1.1rem;
    }
    #checkout {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      font-weight: bold;
      font-size: 1.1rem;
      background: darkgreen;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-toolbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 0.5rem;
      }

      .nav-links {
        justify-content: center;
        gap: 0.5rem;
      }

      .nav-links a {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }

      main {
        margin: 20px auto;
        padding: 0.5rem;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Toolbar -->
  <nav class="nav-toolbar">
    <div class="nav-logo">
      <img src="TM.png" alt="Catfish Empire Logo" onerror="this.style.display='none'" />
      CATFISH EMPIRE™
    </div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="cart.html" class="cart-link">Cart (<span id="cart-count">0</span>)</a>
      <a href="showcase.html">Gallery</a>
      <a href="https://youtube.com/@catfishempire" target="_blank">YouTube</a>
      <a href="https://x.com/CATFISH_EMPIRE" target="_blank">X (Twitter)</a>
      <a href="https://www.facebook.com/share/1B4i7CNrYc/" target="_blank">Facebook</a>
    </div>
  </nav>

  <main>
    <h1>Your Cart</h1>
    <ul id="cart-list"></ul>
    <div class="summary">
      <p><strong>Subtotal:</strong> $<span id="subtotal">0.00</span></p>
      <p style="font-size: 0.95rem; color: gray;">Tax and shipping calculated at checkout</p>
    </div>
    <button id="checkout">Checkout</button>
  </main>

  <script>
    const BACKEND_URL = "https://catfish-stripe-backend.onrender.com";

    function dollars(c){ return (c/100).toFixed(2); }
    function normalizeColor(v){ return String(v || '').trim().toLowerCase(); }
    function normalizeSizeLower(v){ return String(v || '').trim().toLowerCase(); }

    async function hydratePrintfulItem(item){
      if (Number.isFinite(item.priceCents) && item.variantId) return item;
      try {
        const res = await fetch(`${BACKEND_URL}/api/printful-product/${item.productId}`);
        if (!res.ok) return item;
        const data = await res.json();
        const key = `${normalizeColor(item.color)}|${normalizeSizeLower(item.size)}`;
        const variantId = data.variantMatrix?.[key];
        const priceCents = data.priceByKey?.[key];
        if (variantId) item.variantId = variantId;
        if (Number.isFinite(priceCents)) item.priceCents = Number(priceCents);
        return item;
      } catch {
        return item;
      }
    }

    async function loadCart(){
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart = cart.map(it => {
        if (it.type === 'printful') {
          if (!Number.isFinite(it.priceCents) && Number.isFinite(it.price)) {
            it.priceCents = Math.round(Number(it.price) * 100);
          }
          if (!Number.isFinite(it.priceCents)) it.priceCents = 0;
        }
        return it;
      });
      await Promise.all(cart.map(async (it, idx) => {
        if (it.type === 'printful' && (!Number.isFinite(it.priceCents) || !it.variantId)) {
          cart[idx] = await hydratePrintfulItem({ ...it });
        }
      }));
      localStorage.setItem('cart', JSON.stringify(cart));
      return cart;
    }

    function updateCartCount(cart) {
      const totalItems = cart.reduce((sum, item) => sum + (item.qty||1), 0);
      const totalCents = cart.reduce((sum, item) => {
        const cents = item.type === 'printful' ? Number(item.priceCents||0) : 1499;
        return sum + (cents * (item.qty||1));
      }, 0);
      const countEl = document.getElementById('cart-count');
      if (countEl) {
        countEl.textContent = totalItems > 0 ? `${totalItems} ($${dollars(totalCents)})` : '0';
      }
    }

    async function renderCart(){
      const cart = await loadCart();
      const cartList = document.getElementById('cart-list');
      const subtotalEl = document.getElementById('subtotal');
      cartList.innerHTML = '';
      if (!cart.length){
        cartList.innerHTML = '<li>Your cart is empty.</li>';
        subtotalEl.textContent = '0.00';
        updateCartCount(cart);
        return;
      }
      let subtotalCents = 0;
      cart.forEach((item, index) => {
        const itemCents = item.type === 'printful' ? Number(item.priceCents||0) : 1499;
        const itemName = item.type === 'printful' ? (item.name || 'Catfish Empire Product') : `${item.color} Sunglasses`;
        const itemTotalCents = (item.qty||1) * itemCents;
        subtotalCents += itemTotalCents;
        const li = document.createElement('li');
        li.innerHTML = `${item.qty}× ${itemName} - $${dollars(itemTotalCents)} <button class="remove" onclick="removeItem(${index})">Remove</button>`;
        cartList.appendChild(li);
      });
      subtotalEl.textContent = dollars(subtotalCents);
      updateCartCount(cart);
    }

    function removeItem(index) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }

    document.getElementById('checkout').addEventListener('click', async () => {
      const cart = await loadCart();
      if (!cart.length){ alert('Your cart is empty.'); return; }
      const shippingState = localStorage.getItem('shippingState') || 'Unknown';
      const items = cart.map(item => item.type === 'printful' ? ({
        type: 'printful',
        productId: item.productId,
        variantId: item.variantId || item.variant_id,
        name: item.name,
        priceCents: Number(item.priceCents||0),
        currency: item.currency || 'USD',
        image: item.image,
        color: item.color,
        size: item.size,
        qty: item.qty||1
      }) : ({ color: item.color, qty: item.qty||1 }));
      fetch(`${BACKEND_URL}/create-checkout-session`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify({ items, shippingState }) })
        .then(r=>r.json()).then(data=>{ if (data.url) window.location = data.url; else alert('Checkout session failed to create.'); })
        .catch(err=>{ console.error('Error:', err); alert('Failed to connect to payment server.'); });
    });

    renderCart();
  </script>
</body>
</html>
